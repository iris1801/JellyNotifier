{% extends 'layout.html' %}

{% block content %}
<div class="container">
    <h1>Dashboard</h1>
    <p>Totale invii automatici: {{ schedules|length }}</p>

    <h2>Invii Programmati</h2>
    {% if schedules %}
        {% for schedule in schedules %}
        <div class="card">
            <h3>{{ schedule.schedule_name }}</h3>
            <p>Oggetto: {{ schedule.subject }}</p>
            <p>Destinatari: {{ schedule.recipients }}</p>
            <p>Orario di Invio: {{ schedule.schedule_time }}</p>
            {% if schedule.is_recurring %}
                <p>Frequenza: {{ schedule.frequency }}</p>
            {% endif %}
        </div>
        {% endfor %}
    {% else %}
        <p>Nessun invio programmato.</p>
    {% endif %}

    <h2>Eventi Monitorati</h2>
    {% if service %}
        <ul>
            {% if service.monitor_media_added %}
                <li>Media Aggiunti (Frequenza: {{ service.media_added_timeframe }})</li>
            {% endif %}
            {% if service.monitor_media_removed %}
                <li>Media Rimossi (Frequenza: {{ service.media_removed_timeframe }})</li>
            {% endif %}
            {% if service.monitor_stream_started %}
                <li>Stream Avviati (Frequenza: {{ service.stream_started_timeframe }})</li>
            {% endif %}
            {% if service.monitor_transcoding %}
                <li>Transcodifica (Frequenza: {{ service.transcoding_timeframe }})</li>
            {% endif %}
        </ul>
    {% else %}
        <p>Nessun evento monitorato. Configura il servizio Jellyfin per iniziare il monitoraggio.</p>
    {% endif %}

    <!-- Sezione per visualizzare le librerie -->
    <h2>Librerie Jellyfin</h2>
    <div id="libraries">
        <p>Caricamento in corso...</p>
    </div>
</div>

<div class="container">
    <h1>Configurazione Servizi</h1>
    <form method="post">
        <!-- Campi per URL e chiave API -->
        <label for="jellyfin_url">Jellyfin URL</label>
        <input type="text" id="jellyfin_url" name="jellyfin_url" value="{{ service.jellyfin_url }}">
        
        <label for="api_key">Jellyfin API Key</label>
        <input type="text" id="api_key" name="api_key" value="{{ service.api_key }}">

        <!-- Altri campi -->
        <label for="sync_timeframe">Frequenza sincronizzazione (minuti)</label>
        <input type="number" id="sync_timeframe" name="sync_timeframe" value="{{ service.sync_timeframe }}">

        <button type="submit">Salva</button>
    </form>

    <button id="sync-now" class="btn">Sincronizza Ora</button>
</div>

<script>
    document.getElementById("sync-now").addEventListener("click", () => {
        fetch("/services/sync-now", { method: "POST" })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    alert("Sincronizzazione completata.");
                } else {
                    alert("Errore: " + data.error);
                }
            })
            .catch(err => alert("Errore nel tentativo di sincronizzare."));
    });
</script>

<!-- Sezione per JavaScript -->
<script>
    // Funzione per caricare le librerie Jellyfin
    fetch("/dashboard/libraries")
        .then(response => response.json())
        .then(data => {
            const container = document.getElementById("libraries");
            container.innerHTML = ""; // Svuota il contenuto predefinito

            if (data.error) {
                console.error(data.error);
                container.innerText = "Errore: " + data.error;
            } else {
                data.forEach(library => {
                    const item = document.createElement("div");
                    item.classList.add("card"); // Aggiunge stile simile alle altre card
                    item.innerHTML = `
                        <h3>${library.Name}</h3>
                        <p>Elementi: ${library.ItemCount}</p>
                    `;
                    container.appendChild(item);
                });
            }
        })
        .catch(err => {
            console.error(err);
            const container = document.getElementById("libraries");
            container.innerText = "Errore nel recupero delle librerie.";
        });
</script>
{% endblock %}